# Mosquitto Configuration for Meshtastic con SSL/TLS
# Configurazione completa con supporto SSL

# ====================================
# SICUREZZA
# ====================================
allow_anonymous false
password_file /mosquitto/config/pwfile

# ====================================
# LISTENER MQTT STANDARD (Non SSL)
# ====================================
listener 1883
protocol mqtt

# ====================================
# LISTENER WEBSOCKETS (Non SSL)
# ====================================
listener 9001
protocol websockets

# ====================================
# LISTENER MQTT SSL/TLS
# ====================================
listener 8883
protocol mqtt

# Certificati Let's Encrypt
cafile /mosquitto/config/certs/fullchain.pem
certfile /mosquitto/config/certs/fullchain.pem
keyfile /mosquitto/config/certs/privkey.pem

# Versione TLS minima
tls_version tlsv1.2

# Non richiedere certificato client (i dispositivi Meshtastic non lo hanno)
require_certificate false

# Verifica certificato client se presente (opzionale)
# use_identity_as_username false

# ====================================
# LISTENER WEBSOCKETS SSL (Opzionale)
# ====================================
# Decommenta se necessario
# listener 9443
# protocol websockets
# cafile /mosquitto/config/certs/fullchain.pem
# certfile /mosquitto/config/certs/fullchain.pem
# keyfile /mosquitto/config/certs/privkey.pem
# tls_version tlsv1.2

# ====================================
# PERSISTENZA
# ====================================
persistence true
persistence_location /mosquitto/data/
persistence_file mosquitto.db

# Intervallo di salvataggio automatico (in secondi)
autosave_interval 300
autosave_on_changes false

# ====================================
# LOGGING
# ====================================
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

# Tipi di log
log_type error
log_type warning
log_type notice
log_type information

# Timestamp nei log
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# ====================================
# PERFORMANCE E LIMITI
# ====================================
# Numero massimo di connessioni (-1 = illimitato)
max_connections -1

# Numero massimo di messaggi in coda per client
max_queued_messages 1000

# Dimensione massima messaggi (0 = illimitato)
message_size_limit 0

# Max QoS (0, 1, o 2)
max_qos 2

# ====================================
# TIMEOUT E KEEPALIVE
# ====================================
# Keepalive timeout (secondi)
# I dispositivi Meshtastic usano tipicamente 60-300 secondi
keepalive_interval 60

# Timeout per client disconnessi
persistent_client_expiration 1d

# ====================================
# TOPIC E ACL (Opzionale)
# ====================================
# Per limitare accesso ai topic, crea un file ACL
# acl_file /mosquitto/config/acl.conf

# ====================================
# STATISTICHE E MONITORING
# ====================================
# Abilita topic di sistema per monitoring
# Accessibile a: $SYS/#
# sys_interval 10

# ====================================
# BRIDGE (Opzionale)
# ====================================
# Per connettere questo broker ad altri broker MQTT
# Utile per federare pi√π nodi Meshtastic
# connection bridge-name
# address mqtt.example.com:1883
# topic # both 0

# ====================================
# PLUGIN (Opzionale)
# ====================================
# auth_plugin /path/to/plugin.so
# auth_opt_* per configurare plugin

# ====================================
# NOTE PER MESHTASTIC
# ====================================
# I dispositivi Meshtastic usano:
# - Topic root: msh/ (default)
# - QoS: 0 o 1
# - Retain: false (generalmente)
# - Keepalive: 60-300 secondi
#
# Topic comuni:
# - msh/2/c/LongFast/!all
# - msh/2/e/YOUR_NODE_ID
# - msh/2/stat/YOUR_NODE_ID
